{% comment %}<!--
  Using dump-multisigs from img/posts/2021-07-multisig-fungibility.gnuplot

    for i in `seq 691039 692039` ; do dump-multisigs $i ; done > RESULTS
    echo $( grep of RESULTS | wc -l ) / $( cat RESULTS | wc -l ) | bc -l
-->{% endcomment %}
この記事を書く前に受信した1,000ブロックでは、全トランザクションインプットの11%がマルチシグopcodeを含んでいました。
このようなトランザクションを作成するユーザーやサービスの多くが、
マルチシグopcodeからScriptlessな[マルチシグ][topic multisignature]に切り替えると、
Taprootの最大かつ最も直接的な2つのメリットが得られます。

1つめの大きなメリットは、トランザクションサイズの削減です。
Scriptベースのマルチシグは、必要とされる鍵や署名が増えるとサイズも増加しますが、
Scriptlessなマルチシグは一定の小さなサイズです。
最小の効果的なマルチシグポリシー（1-of-2）は、数千の署名者が関与する可能性のあるマルチシグポリシーよりも多くのスペースを必要とします。
サイズの削減は、マルチシグユーザーにとっては直接的な手数料削減になり、
すべてのユーザーにとっては、より少ないブロックスペースで同じ量の承認済みトランザクションが受け入れられるため、
間接的な手数料削減につながります。

{:.center}
![Plot showing the savings for multisignatures compared to multisig](/img/posts/2021-07-multisignature-savings.png)

2つめの大きなメリットは、プライバシーの向上です。
マルチシグの使用は、ブロックチェーン上に明確に記録され、
観察者はそれをもとに個々のユーザーのウォレットの履歴や現在の残高を推測することができます。
例えば、ブロック692,039を見ると、マルチシグの使用とシングルシグの使用を区別できるだけでなく、
マルチシグのセットのサイズや閾値の違いも識別できます。

{:.center}
![Illustration of the lack of witness fungibility in current blocks](/img/posts/2021-07-multisig-unfungible.png)

比較すると、ブロックチェーンのデータのみを調べている第三者は、使用者がマルチシグを使用していることを知ることができません。
keypathの使用でマルチシグが使用されている場合、シングルシグの使用と区別できません。
上記のブロックの全てのシングルシグとマルチシグがP2TRのkeypathの使用に切り替えられた場合、
Scriptで区別できるのは一部の風変わりな使用のみです（そして、それらでさえ、ベストケースではkeypathによる使用が可能です）。

{:.center}
![Illustration of how fungibile witnesses could be ideally](/img/posts/2021-07-multisignature-fungible.png)

### マルチシグの使用

Bitcoin用に設計された3つのSchnorrベースのマルチシグスキームがあり、
いずれも[MuSig][topic musig]ファミリーのメンバーです:

- **MuSig** (MuSig1と呼ばれる)は、実装は簡単ですが、署名プロセスで3ラウンドの通信を必要とします。

- **MuSig2**は、これも実装が簡単です。
  MuSig2は、1ラウンドの通信を省き、もう1ラウンドを鍵交換と組み合わせることができます。
  これにより、現在使われているScriptベースのマルチシグと同様の署名プロセスを使用することができます。
  ただ、追加のデータを保存したり、
  署名を行うソフトウェアやハードウェアが騙されて署名セッションの一部を繰り返してしまわないようにする必要があります。

- **MuSig-DN** (Deterministic Nonce)は、実装が非常に複雑です。
  参加者間の通信を鍵交換と組み合わせることはできませんが、
  反復セッション攻撃に対して脆弱ではないというメリットがあります。

すべての署名者は使用するプロトコルに同意しなければならないため、
多くの実装が同じプロトコルを選択するというネットワーク効果が発生する可能性があります。
MuSigの提案の著者は、比較的シンプルで実用性の高いMuSig2の選択を[提案しています][nick ruffing blog]。
<!-- "[...] there is no reason to prefer MuSig1 over MuSig2
[...] we expect that most applications will choose MuSig2 over MuSig-DN
[...]" -->

libsecp256k1-zkpプロジェクトにはMuSig2のサポートを追加するための[PR][-zkp 131]が公開され、
活発な開発が行われています。基本的なマルチシグのワークフローは以下のようになると考えています:

1. 各参加者のウォレットは、[BIP32][]のxpubを生成し、
   それを[output script descriptor][topic descriptors]やその他の方法で他の参加者全員と共有します
   （現在、マルチシグで一般的に行われている方法と同じです）。

2. また、ウォレットは他の参加者と共有するnonceのセットを生成します。
   ウォレットはBIP32強化導出を使ってこれらのnonceを生成できます。
   nonceは32バイトで、1つの署名につき2つ必要です。使用頻度の低いウォレットは、
   ウォレットの全ライフタイムで必要なすべてのnonceを事前に共有できます。
   （LNルーティングノードなど）より頻繁に使用されるウォレットの場合、
   各ウォレットは現在のトランザクションの署名と次のトランザクション用nonceを一緒に送信できます。

3. いずれのウォレットも、特定のBIP32の深さの公開鍵と、
   マルチシグ・アソシエーションの他のすべてのウォレットの同じ深さの公開鍵を組み合わせることで、
   集約公開鍵を生成することができます。この集約公開鍵を使ってP2TR支払いを受け取ることができます。

4. ウォレットの1つが資金を使用したい場合、Scriptベースのマルチシグと同様、
   [PSBT][topic psbt]ベースのワークフローを使用します。
   Scriptベースのマルチシグと違い、ウォレットは自分の次のnonceと他の参加者全員の次のnonceを使って、
   MuSig2のアルゴリズムに従って共有nonceを作成し、そのnonceとトランザクションに対して部分署名を作成します。

5. 他のウォレットはPSBTを受け取ると、同じ手順を実行します。
   次に、部分署名を組み合わせて最終的な署名を作成し、トランザクションをブロードキャストします。

### 閾値署名

マルチシグスキームのMuSigファミリーはn-of-nの署名のみを提供します。
集約公開鍵に鍵を提供するすべての参加者は、最終的な署名にも部分署名を提供する必要があります。
これは、2-of-2のLNのファンディング・アウトプットなど、
現在のScriptベースのマルチシグの一部の用途を直接置き換えるものとしては完璧に動作しますが、
多くの取引所で使用されている2-of-3のマルチシグなど他の一般的なポリシーとは異なります。

複数の開発者が、
このマルチシグと同じ効率およびプライバシーの利点をk-of-nのシナリオにもたらす[閾値署名][topic threshold signature]スキームに取り組んでいますが、
それらのスキームが利用可能になるまで使用できる簡単なトリックがあります。

閾値署名は多くの場合、どの参加者が署名する可能性が最も高いかが事前に分かっています。
例えば、2-of-3のケースでは、通常はアリスとボブが共同で署名し、
キャロルはメンバーのいずれかが不在の場合にのみ署名することが分かっているかもしれません。
このようケースでは、メインとなる鍵はTaprootのkeypathによる使用（例：アリスとボブとの間）にマルチシグを使用することができ、
追加の条件（アリスとキャロル、もしくはボブとキャロル）は、
[Tapscript][topic tapscript]のツリー内の別々のブランチで`OP_CHECKSIG`
opcodeを使ったマルチシグを使用することができます。

通常のケースでは、上記はシングルシグまたはマルチシグのトランザクションと全く同じ効率とプライバシーを持っています。
特異なケースでも、使用は期待どおりに機能し、
マルチシグのパラメーターをオンチェーンで公開するよりも効率的でプライバシーが保たれます。

最小限の手数料と最大限のプライバシーを望むユーザーは、
最終的に純粋な閾値署名スキームに切り替えるかもしれませんが、
上記の[スキーム][erhardt post]は、（参加者のすべての公開鍵を知っている場合）監査人に対して、
どの対応する秘密鍵が署名に使われたかをオンチェーンで証明することができるため、引き続き使用される可能性もあります。

[nick ruffing blog]: https://medium.com/blockstream/musig2-simple-two-round-schnorr-multisignatures-bf9582e99295
[-zkp 131]: https://github.com/ElementsProject/secp256k1-zkp/pull/131
[erhardt post]: https://murchandamus.medium.com/2-of-3-multisig-inputs-using-pay-to-taproot-d5faf2312ba3
