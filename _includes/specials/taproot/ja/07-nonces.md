[先週のコラム][p4tr multisignatures]では、[マルチシグ][topic multisignature]について書き、
[MuSig2][topic musig]を使った例を紹介しました。
私たちの説明は技術的には正しいと思われますが、MuSig2に貢献した何人かの暗号技術者は、
私たちが提案した使い方は危険だと[心配していました][secp256k1 log]。
私たちは、当面の懸念に対応するため説明を[更新し][optech #622]、
その後、この問題をより徹底的に調査しました。
この記事では、マルチシグを安全に実装するための最大の課題であると思われるnonceの再利用の回避について説明します。

Bitcoinで署名を検証するには、署名と署名されたメッセージ（トランザクションなど）、
公開鍵、公開nonceを公開されている方程式に入力します。
この方程式が成立するのは、自分の秘密鍵とnonceの秘密情報を知っている場合だけです。
したがって、成立した方程式を確認した人は、そのメッセージと公開鍵に対する署名が有効であると考えます。

署名とメッセージを方程式に含める動機は明らかです。公開鍵は秘密鍵の代用です。
公開nonceは何のためのものでしょうか？これがなければ、方程式内の秘密鍵以外の値はすべて分かっているため、
基本的な代数を使って未知の1つの値を解くことができます。しかし代数学では、
2つの未知の値を解くことはできません。そのためnonceの秘密の情報は、あなたの秘密鍵を隠す役割をします。
また、公開鍵が署名式の中で秘密鍵の代用となっているように、nonceの公開情報は秘密情報の代用となっています。

ここでいうnonceとは、*一度使っただけの数値*ではなく一度しか使っては**ならない**数値のことです。
同じnonceを異なる2つの署名で再利用すると、2つの署名式を組み合わせてnonceを打ち消し、
唯一の残った未知の値であるあなたの秘密鍵を再び誰かが解くことができます。
[BIP32][]標準の導出（非強化導出）を使用している場合、ほとんどのマルチシグウォレットがそうであるように、
1つの秘密鍵が明らかになると、同じBIP32パス内（おそらく他のパスも同様）にある他のすべての秘密鍵も明らかになります。
つまり、100個の異なるアドレスでビットコインを受け取ったマルチシグウォレットは、
署名者がnonceを1つでも再利用すると、それらのアドレスの全てが危険にさらされることになります。

シングルシグのウォレットや、スクリプトベースのマルチシグを使用しているウォレットは、
nonceの再利用を避けるために、nonceを署名しようとしているメッセージに依存させるという
簡単なトリックを使用できます。メッセージに変更があると、nonceも変わるため、nonceが再利用されることはありません。

マルチシグにはこのトリックは使えません。すべての共同署名者は、部分署名だけでなく、
部分公開nonceも提供する必要があります。部分公開nonceは結合されて、集約公開nonceとなり、
署名するメッセージに含まれます。

つまり、トランザクションが同じでも、同じ部分nonceを2回以上使用することは安全ではありません。
2回めの署名の際に、あなたの共同署名者が部分nonceを変更した（集約nonceを変更した）場合、
2回めの部分署名は異なるメッセージに対するものになります。
そうなるとあなたの秘密鍵が明らかになります。
すべての参加者が自分のnonceの秘密を、他のすべての参加者の部分公開nonceに依存させるのは循環的で不可能であるため、
マルチシグでnonceの再利用を避けるための簡単なトリックはありません。

一見すると、これは大きな問題ではないように思えます。
署名者はなにかに署名するたびに、新しいランダムなnonceを生成すればよいのです。
これは思ったより正しく理解するのが難しいものです。少なくとも[2012][tcatm post]年以降、
ランダムなnonce生成に依存するウォレットでビットコインを失うバグが発見されています。

しかし、たとえウォレットが高品質なランダムnonceを生成したとしても、
各nonceは最大で1回しか使用されないようにしなければなりません。
先週のコラムの原文では、MuSig2と互換性のあるコールドウォレットやハードシェア署名デバイスについて掲載していましたが、
これらのデバイスは最初の実行時に大量のnonceを作成します。
ウォレットやデバイスは、これらのnonceを2つ以上の部分署名で使用されないようにする必要があります。
nonceが使用されるたびにカウンターをインクリメントするだけの簡単なことのように聞こえますが、
外部からの悪意ある介入による影響はもちろんのこと、
ソフトウェアやハードウェアが偶発的に故障する可能性があることを考えると、本当に難しいことです。

ウォレットがnonceの再利用のリスクを減らす最も簡単な方法は、nonceをできるだけ短期間保存することでしょう。
先週の例では、nonceを数ヶ月から数年にわたって保存することを提案しましたが、
これは何か問題が発生する可能性が高いだけでなく、
バックアップや復元、予期せぬ状態になる可能性のある永続的なストレージにnonceを記録する必要があります。
MuSig2を使用する別の方法としては、[PSBT][topic psbt]を受信したときなど、
必要に応じてnonceを作成する方法です。nonceは必要な短時間だけ揮発性のメモリに保持しておき、
ソフトウェアのクラッシュや電源の喪失など予期せぬ事態が起こった場合には、
自動的に破壊される（再利用できなくなる）ようにしておくことができます。

しかし、この問題に取り組んでいる暗号技術者は、オリジナルのMuSigプロトコル（MuSig1）やMuSig2において、
nonceの再利用を防ぐための確実な方法がないことを非常に懸念しているようです。
MuSig-DN (deterministic nonce)は解決策を提供していますが、
複雑で時間がかかります（アルファ版の実装では、2.9 GHzのIntel i7でnonceの証明を作成するのに約1秒かかり、
それよりもはるかに性能の低い16 MHzのハードウェア署名デイバイスでどれだけ時間がかかるかは不明です）。

マルチシグ署名を実装する方へのアドバイスとしては、時間やリソースに大きな投資をする前に、
IRCの[#secp256k1][]ルームやBitcoinの暗号技術者が集まる他の場所に立ち寄って、
計画を説明することを検討してください。

[secp256k1 log]: https://gnusha.org/secp256k1/2021-08-04.log
[tcatm post]: https://web.archive.org/web/20160308014317/http://www.nilsschneider.net/2013/01/28/recovering-bitcoin-private-keys.html
[#secp256k1]: https://web.libera.chat/?channels=#secp256k1
[p4tr multisignatures]: /ja/preparing-for-taproot/#マルチシグの概要
[optech #622]: https://github.com/bitcoinops/bitcoinops.github.io/pull/622
