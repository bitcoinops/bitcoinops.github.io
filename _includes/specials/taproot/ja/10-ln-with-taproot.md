*LNプロトコル開発者[ZmnSCPxj][]の寄稿*

この投稿では、[Taproot][topic taproot]がLNで可能にする2つのプライバシー機能について説明します:

* LN上の[PTLC][topic ptlc]
* P2TRチャネル

### LN上のPTLC

PTLCは[多くの機能][suredbits payment points]を可能にしますが、
LNにとっての主な機能は、経路をランダム化することなく[支払いを非相関化][p4tr ptlcs]する機能です。[^route-randomization]
シングルパスや[マルチパス][topic multipath payments]の経路に沿ったすべてのノードに、
転送される各PTLCを調整するために使用されるスカラーを与えることができ、
個々の転送が各LN支払い用の一意な識別子を[漏らす][news163 htlc problems]ことのない*支払いの非相関化*を可能にします。

PTLCは***プライバシーの万能薬ではありません***。
監視ノードが特定のタイムロックと量を持つ転送を発見し、
その直後に2つめの監視ノードが*より小さな*タイムロックと*僅かに少ない*量を持つ転送を発見した場合、
たとえ監視ノードが一意に識別可能なハッシュを介してそれらを相関させることができなくなったとしても、
これらの転送が同じ支払いのパスに属する*可能性は非常に高い*です。しかし、得るものはあります:

* 分析の不確実性が増します。監視者が扱うことのできる確率が低くなり、情報の価値ははるかに低くなります。
* マルチパス支払いでは、より*多くの*非相関化が行われます。
  個別のパスには、それぞれタイムロックや量に強い相関関係はないでしょうし、
  LNが成功すれば、タイミングの相関関係も信頼できないほど十分な支払いがあるでしょう。
* [HTLC][topic htlc]と比較してコストは増加しません
  （[マルチシグの効率化][p4tr multisignatures]により、わずかにコストが減少する可能性もあります）。

原則として、Taproot前のチャネルは、チャネルを閉じて再度開くことなく、
PTLCをサポートするようアップグレードすることができます。
既存のチャネルは、既存の非Taprootのファンディング・アウトプットを
PTLCを含むTaprootアウトプットへ送信するオフチェーントランザクションを作成することで、PTLCをホストすることができます。
つまり、LN上でPTLCのサポートを追加しても、
各ノードとそのチャネルピアがソフトウェアをアップグレードする以上のコストがユーザーにかかることはないということです。

しかし、PTLCを実際に使用するためには、送信者から受信者までの*すべての*転送ノードがPTLCをサポートする必要があります。
つまり、十分な数のノードがアップグレードするまで、PTLCのサポートはほとんど使われない可能性があります。
すべてのノードが同じプロトコルを使用する必要はありませんが（複数のPTLCプロトコルが存在する可能性があります）、
すべてのノードが何らかのPTLCプロトコルをサポートする必要があります。
複数のPTLCプロトコルをサポートすることになると、メンテナンスの負担が増えるため、
そのようなプロトコルが多くならないことを*願っています*（理想的には１つだけ）。

### P2TRチャネル

ベースレイヤーとLNレイヤー間の非相関化を改善するための1つのソリューションは、
LN上でその存在がゴシップされないチャネルである[非公開チャネル][topic unannounced channels]でした。

残念ながら、すべてのLNチャネルは2人の署名者の協力を必要とし、現在のTaproot前のBitcoinでは、
すべての2-of-2のScriptが*オープンに*コーディングされています。
LNは2-of-2マルチシグの最も一般的なユーザーであるため、ブロックチェーンエクスプローラであれば、
これが閉じられたLNチャネルであることを示すことができます。
そこから資金を辿ることができ、それが別のP2WSHアウトプットに向かっていれば、
それは*別の*非公開チャネルである可能性が高くなります。
このように、非公開チャネルであっても、ある程度の誤検出はあるものの、閉じるとオンチェーンで特定することができます。

Taprootは、[Schnorr署名][topic schnorr signatures]を使用することで、
n-of-nを1-of-1と全く同じように見せることができます。
少し工夫すれば、[k-of-n][topic threshold signature]でも1-of-1（およびn-of-n）と同じように見えます。
そして、LNチャネルがP2TR UTXO、つまりP2TRチャネルを使うことで、
非公開チャネルの*オンチェーン*プライバシーを向上させることができます。[^two-to-tango]

<!-- P2WSH 2-of-2: itemCount OP_0 <sig> <sig> <2 <key> <key> 2 OP_CMS>
             220 =   1 + 1 + 1+72 +1+72 +1+1+1+33+1+33+1+1

                  outpoint + nSequence + scriptSig + witness
             96 = 36 + 4 + 1 + 220/4
     P2TR: itemCount <sig>
             66 = 1 + 1 + 64

                    outpoint + nSequence + scriptSig + witness
             57.5 = 36 + 4 + 1 + 66/4

    Comparison:
      38.5 = 96 - 57.5
      ~40% = 1 - 57.5 / 96
-->

この（かなり小さな）プライバシーの向上は、公開チャネルにも役立ちます。
公開チャネルは、公開されている間だけゴシップされるので、
公開チャネルを探そうとしても、*過去の*チャネルについて知ることはできません。
監視者がすべての公開チャネルを確認したい場合、そのデータをすべて自身で保持しなければならず、
アーカイブノードに頼ることはできません。

さらに、Taprootのkeypathによる使用は、LNの既存のP2WSHの使用に比べて38.5 vbyte (40%)小さくなります。
残念ながら、**既存のTaproot前のチャネルをP2TRチャネルにアップグレードすることはできません**。
既存のチャネルは、既存のP2WSH 2-of-2スキームを使用しており、
P2TRチャネルに切り替えるにはチャネルを閉じなければなりません。

理論的には、実際のファンディング・トランザクションのアウトポイントは、
チャネルを使用する2つのノードにのみ関係します。
ネットワーク上の他のノードは、2つのノード間のチャネルのセキュリティには関心がありません。
しかし、公開チャネルはLNのゴシップネットワーク上で共有されます。
ノードがゴシップされた公開チャネルを受信すると、ノードは自身の信頼できるBitcoinフルノードを参照し、
ファンディングのアウトポイントが存在するか、さらに重要なことに**正しいアドレスを持っているか**を確認します。
アドレスを確認することで、チャネルゴシップの仕組みをスパムするのが困難になります。
チャネルゴシップを送信するためには、実際にブロックチェーン上に資金が必要です。
したがって、実際には、P2TRチャネルであってもある程度のリモート互換性が必要です。
そうでなければ、送信者はこれらのチャネルが*存在すること*を検証できないため、
これらのチャネルを無視してルーティングを行います。

### タイムフレーム

分散型FOSSプロジェクトで機能のタイムフレームを作るには、*過去の*機能とそれにかかった時間を調べ、
それらの機能を実際に展開するのにかかる時間を基準にするのが、最良の方法だと思います。[^planning-details]

最近の新機能の中で、LNを介したPTLCとスコープが似ていると思うのは[デュアル・ファンディング][topic dual funding]です。
Lisa Neigutが[BOLTs #524][]でデュアル・ファンディングの最初の提案をし、
その約2年6ヶ月後に[mainnetで最初のデュアル・ファンディングチャネル][neigut first dual funded]が[開設されました][first dual funded tx]。
デュアル・ファンディングに必要なのは、直接のピアとの互換性だけです。
LN上のPTLCは、受信者を含む選択した経路上のルーティングノードとの互換性を必要とします。
そのため、この機能には追加の複雑さを理由に+50%の時間補正をするのが妥当だと考えており、
具体的なPTLCプロトコルが提案されてから、3年9ヶ月を目安にしています。

P2TRチャネルについては、これは2つの直接のピア間のみの話で、利点も少ないことに注意してください。
そのため優先度は低くなると思います。ほとんどの開発者がPTLC-over-LNを優先すると仮定すると、
P2TRチャネルは、基礎となる[SIGHASH_ANYPREVOUT][topic sighash_anyprevout]や、
Decker-Russell-Osuntokun("[Eltoo][topic eltoo]")を実装する他の方法が利用可能になる頃には、
作業が開始されると予想されます。

[^route-randomization]:
    支払者は、HTLCの相関分析を誤らせるために、
    非常に複雑なパス（つなり経路のランダム化）を選択することができますが、
    それには欠点があります:

    * 複雑なパスは、コストがかかり、*かつ*信頼性も低いものになります
      （より多くのノードに支払いを行い、支払いが宛先に到達するためには
      より多くのノードが転送に*成功する*必要があります）。
    * 複雑なパスは長いので、支払者は支払いについてより*多くの*ノードに伝えることになり、
      監視ノードに当たる可能性が*高く*なります。
      このように複雑なパスは、必ずしもプライバシーを完全に改善するものではありません。

[^planning-details]:
    確かに詳細は重要ですが、それだけではありません。高い視点から見ると、
    開発のある側面での予期せぬ困難と、開発の他の側面での予期せぬ非困難は相殺され、
    すべての主要な機能は、ある平均的なタイムフレームにほぼ沿っていることになります。
    **感覚的な**見積もりではなく、**正確な**見積もりをしたいのであれば、
    [計画錯誤][WIKIPEDIAPLANNINGFALLACY]を避ける方法を使うべきです
    つまり、過去に完成した似たような機能を探し、その詳細を*わざと無視して*、
    その機能の実装にかかった時間だけを見るのです。

[^two-to-tango]:
    非公開チャネルを検討する際には、タンゴを踊るには二人必要なことを思い出してください。
    非公開チャネルを閉じる場合、もう1人の参加者（例えばLNサービスプロバイダー）が残りの資金を*公開*チャネルに使用した場合、
    ブロックチェーンエクスプローラは、資金のソースが閉鎖された非公開チャネルであった可能性をある程度推測できます。

{% include references.md %}
{% include linkers/issues.md issues="524" %}
[zmnscpxj]: https://zmnscpxj.github.io/about.html
[suredbits payment points]: https://suredbits.com/payment-points-monotone-access-structures/
[WIKIPEDIAPLANNINGFALLACY]: https://en.wikipedia.org/wiki/Planning_fallacy
[neigut first dual funded]: https://medium.com/blockstream/c-lightning-opens-first-dual-funded-mainnet-lightning-channel-ada6b32a527c
[first dual funded tx]: https://blockstream.info/tx/91538cbc4aca767cb77aa0690c2a6e710e095c8eb6d8f73d53a3a29682cb7581
[russell deployable ln]: https://github.com/ElementsProject/lightning/blob/master/doc/deployable-lightning.pdf
[p4tr ptlcs]: /ja/newsletters/2021/08/25/#taprootの準備-10-ptlc
[p4tr multisignatures]: /ja/newsletters/2021/08/04/#taprootの準備-7-マルチシグ
[news163 htlc problems]: /ja/newsletters/2021/08/25/#htlcのプライバシーの問題
