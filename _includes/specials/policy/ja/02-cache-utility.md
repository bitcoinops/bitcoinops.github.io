[先週の記事][policy01]では、mempoolについて、未承認トランザクションのキャッシュとして、
ユーザーがトランザクションをマイナーに送信するための分散化された方法を提供するものであると説明しました。
しかし、マイナーはそのトランザクションを承認する義務はなく、
コインベーストランザクションだけを含むブロックはコンセンサスルールにおいて有効です。
ユーザーは、トランザクションの総アウトプット額を変更せずに、総インプット額を増やすことで、
マイナーに自分のトランザクションを承認するインセンティブを与え、
マイナーはその差額をトランザクション _手数料_ として請求することができます。

トランザクション手数料は、従来の金融システムでは一般的ですが、
新規のBitcoinユーザーは、オンチェーン手数料が取引額に比例するのではなく、
トランザクションのweightによって支払われることに驚くことがよくあります。
流動性ではなくブロックスペースが制限要因になります。
_手数料率_ は通常、仮想バイト（virtual byte）あたりのsatoshiで表されます。

コンセンサスルールにより、各ブロックでトランザクションが使用するスペースが制限されています。
この制限により、ブロックの伝播時間がブロック間隔に対して低く保たれ、
ブロックが古くなってしまう（ステイルブロック）リスクが軽減されます。
また、ブロックチェーンとUTXOセットの増加を抑制することができ、
これらはフルノードの立ち上げと維持にかかるコストに直接貢献します。

このように、未承認トランザクションのキャッシュとしての役割の他に、
mempoolはブロックスペースの公開オークションを促進します。
正常に機能している場合、オークションは自由市場の原則に従います。
つまり、優先順位はマイナーとの関係でははなく、純粋に手数料に基づきます。

ブロックのトランザクションを選択する際に手数料を最大化することは（総weightと署名操作の数の制限あり）、
[NP困難な問題][NP-hard problem]です。
この問題は、トランザクションの関係性によってさらに複雑になります。
高手数料率のトランザクションをマイニングするには、その低手数料率の親をマイニングする必要があるかもしれません。
別の言い方をすると、低手数料率のトランザクションをマイニングすることで、
高手数料率のその子をマイニングする機会が生まれるかもしれません。

Bitcoin Coreのmempoolは、各エントリとその祖先の手数料率を計算し（_祖先手数料率_ と呼ばれる）、
その結果をキャッシュし、貪欲ブロックテンプレート構築アルゴリズムを使用します。
mempoolを _祖先スコア_ （祖先手数料率と個別手数料率の最小値）順にソートし、
その順番で祖先パッケージを選択し、残りのトランザクションの祖先手数料とweight情報を随時更新していきます。
このアルゴリズムは、性能と収益性のバランスを取るものであり、必ずしも最適な結果が得られるとは限りません。
その有効性は、トランザクションと祖先パッケージのサイズを制限することで向上させることができます。
Bitcoin Coreでは、その制限がそれぞれ400,000 weightと404,000 weightに設定されています。

同様に、高手数料率の子を持つ低手数料率のトランザクションを退去させるのは不利になるため、
mempoolから退去させるパッケージを選択する際に使用される _子孫スコア_ が計算されます。

mempoolの検証では、同じインプットを使用するトランザクション（つまり二重支払いや、競合するトランザクション）を処理する際も、
手数料と手数料率が使用されます。ノードは最初に確認したトランザクションを常に保持するのではなく、
一連のルールを使用して、どのトランザクションを保持するインセンティブがより高いかを決定します。
この動作は[Replace by Fee][topic rbf]として知られています。

マイナーが手数料を最大化するのは直感的に理解できますが、
なぜマイニングを行わないノードのオペレーターがこのようなポリシーを実行しなければならないのでしょうか？
先週の記事で説明したように、マイニングを行わないノードのmempoolの効用は、
マイナーのmempoolとの類似性に直接関係しています。
そのため、ノードオペレーターがmempoolの内容を使ってブロックを生成するつもりがなくても、
最もインセンティブに適合したトランザクションを維持することに関心があります。

トランザクションに手数料の支払いを要求するコンセンサスルールはありませんが、
手数料と手数料率は、ブロックスペースをめぐる競争を解決するための「公平な」方法として、
Bitcoinネットワークで重要な役割を果たしています。
マイナーは手数料率を使用して、受け入れ、退去および競合を評価し、
マイニングを行わないノードは、自分のmempoolの効用を最大化するためにその動作を反映します。

ブロックスペースの希少性は、トランザクションのサイズに低下圧力をかけ、
開発者がトランザクションをより効率的に構築するよう促します。
来週の記事では、オンチェーントランザクションの手数料を最小化するための実践的な戦略と技術を探ります。

[policy01]: /ja/newsletters/2023/05/17/#承認を待つ-1-なぜmempoolがあるのか
[np-hard problem]: https://ja.wikipedia.org/wiki/NP困難
