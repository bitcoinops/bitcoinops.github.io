<!--
  300 to 1000 words
  put title in main newsletter
  put links in this file
  for any subheads use h3 (i.e., ###)
  illustrations welcome (max width 800px)
  if uncertain about anything, just do what seems best and harding will edit
-->
先週、トランザクションは送金した額ではなく使用するブロックスペースに対して手数料を支払うと述べ、
マイナーは収集できる手数料を最大化するためにトランザクションの選択を最適化することを確認しました。
その結果、ブロックが見つかったときにmempoolの最上位に存在するトランザクションのみが承認されることになります。
この記事では、手数料を最大限に活用するための実践的な戦略について説明します。
手数料率の見積もりの適切な情報源があると仮定します。手数料率の見積もりについては、来週の記事で詳しく説明します。

トランザクションを構築する際、トランザクションのいくつかの部分は、他の部分よりも柔軟性があります。
すべてのトランザクションにはヘッダーフィールドが必要で、受信者のアウトプットは行われる支払いによって決まり、
ほとんどのトランザクションにはお釣りのアウトプットが必要です。
送信者と受信者の両方が、将来のトランザクションアウトプットの支払いコストを削減するために、
ブロックスペース効率の良いアウトプットタイプを優先すべきですが、
トランザクションの最終構成とweightを変更する余地が最も大きいのは、
[インプットの選択][topic coin selection]時です。
トランザクションは、手数料率[fee/weight]で競争するため、
軽いトランザクションは同じ手数料率に達するのにより低い手数料ですみます。

Bitcoin Coreウォレットなど一部のウォレトは、お釣りのアウトプットが必要ないように、
インプットを組み合わせようとします。お釣りを避けることは、
現在のアウトプットのweightを節約するだけでなく、後でお釣りのアウトプットを使用するという将来のコストも削減します。
しかし、ウォレットがさまざまな額を持つ大きなUTXOプールを持っていない限り、
このようなインプットの組み合わせはめったにありません。

最新のアウトプットタイプは、古いアウトプットタイプよりもブロックスペース効率が高くなっています。
たとえば、P2TRインプットを使用すると、P2PKHインプットの2/5以下のweightしか発生しません。
（[トランザクションサイズ計算ツール][transaction size calculator]で試してみてください）
マルチシグウォレットの場合、最近完成した[MuSig2][topic musig]方式やFROSTプロトコルによって、
マルチシグ機能をシングルシグインプットのように見えるものにエンコードすることができ、
大幅なコスト削減が可能になります。特にブロックスペースの需要が急増した時には、
最新のアウトプットタイプを使用するウォレットは、それだけで大きなコスト削減につながります。

{:.center}
![Overview of input and output weights](/img/posts/specials/input-output-weights.png)

スマートウォレットは、手数料率に応じて選択の戦略を変更します。
手数料率が高い場合は、インプットのセットのweightをできるだけ小さくするために、
少ないインプットと最新のインプットタイプを使用します。
常に最も軽いインプットのセットを選択することで、現在のトランザクションのコストを局所的に最小化することができますが、
同時にウォレットのUTXOプールを小さな断片にすることになります。
このため、ユーザーはその後、高い手数料率で巨大なインプットのセットを持つトランザクションを作ることになります。
したがって、ウォレットが低手数料率でより多くの重いインプットを選択し、
その後のブロックスペース需要の急増を見越して、
より少ない最新のアウトプットに資金を集約することは先見の明があると言えます。

大量の支払いをするウォレットは、1回あたりの支払いのトランザクションweightを減らすために、
複数の支払いを1つのトランザクションにまとめることがよくあります。
支払い毎にヘッダーバイトとお釣り用のアウトプットのオーバーヘッドを負担するのではなく、
すべての支払いで共有されるオーバーヘッドコストだけを負担します。
いくつかの支払いをまとめるだけでも、支払い毎のコストはすぐに削減されます。

![Savings from payment batching with
P2WPKH](/img/posts/payment-batching/p2wpkh-batching-cases-combined.png)

しかし、多くのウォレットが過払いな手数料率を推定しているにもかかわらず、
ブロックが遅くなったり、トランザクションの送信が急増すると、
トランザクションが予定よりも長く未承認のままになることがあります。
このような場合、送信者または受信者のどちらかがトランザクションの優先順位を変更したいと思うかもしれません。

一般に、ユーザーは自分のトランザクションの優先順位を上げるために、
[CPFP][topic cpfp]（Child Pays For Parent）と[RBF][topic rbf]（Replace By Fee）の2つのツールを使うことができます。
CPFPでは、ユーザーは自分のトランザクションのアウトプットを使用して、高手数料率の子トランザクションを作成します。
先週の記事で説明したように、マイナーには手数料の高い子を含めるために親をブロックに含めるインセンティブがあります。
CPFPはトランザクションによて支払いを受けるユーザーなら誰でも利用できるため、
受信者または送信者（お釣り用のアウトプットを作成した場合）のどちらでも利用できます。

RBFでは、送信者は元のトランザクションより高い手数料率の置換トランザクションを作成します。
置換トランザクションは、元のトランザクションとの競合を確実にするため、
元のトランザクションから少なくとも１つのインプットを再利用しなければならず、
2つのトランザクションの内、1つだけがブロックチェーンに含まれます。
通常、この置換には元のトランザクションの支払いが含まれますが、
送信者は置換トランザクションの資金をリダイレクトしたり、
複数のトランザクションの支払いを置換トランザクションに統合したりすることもできます。
先週の記事で説明したように、ノードは元のトランザクションを退去させ、
よりインセンティブの高い置換トランザクションを採用します。

ブロックスペースの需要と生産は、どちらも私たちのコントロールが及ばないものですが、
ウォレットがブロックスペースを効果的に競り落とすために使えるテクニックはたくさんあります。
ウォレットは、お釣り用のアウトプットを排除したり、ネイティブsegwitアウトプット使用したり、
低手数料率の環境でUTXOプールをデフラグしたりすることで、より軽いトランザクションを作成して手数料を節約できます。
CPFPとRBFをサポートするウォレットは、控えめな手数料率から始めて、
必要に応じてCPFPまたはRBFを使ってトランザクションの優先順位を更新することもできます。

[transaction size calculator]: /en/tools/calc-size