[BIP173][] 禁止 bech32 地址使用大小写混合。书写 bech32 地址的首选方式是全小写，但在某种情况下，全大写是有意义的：二维码。看看以下两个二维码，虽然它们的地址相同，但一个是小写，另一个是大写：

![bech32 全大写](/img/posts/2019-05-bech32-qr-uc.png)
{:.center}

这是 bech32 的一个故意设计特性。二维码可以用多种模式创建，这些模式支持不同的字符集。二进制模式字符集用于传统地址，因为它们需要混合大小写。然而，比特币的 Bech32 地址[^only-bc] 只使用数字和大写字母表示，因此它们可以使用较小的大写字母和数字字符集。因为这个字符集较小，它在二维码中对每个字符编码所使用的位更少，使得生成的二维码不那么复杂。

比特币地址通常在 [BIP21][] URI 中使用。BIP21 技术上要求 base58check 格式化，但至少一些支持原生 segwit 地址的钱包（如 Bitcoin Core）允许它们与 bech32 一起使用。虽然 BIP21 的方案标识符 `bitcoin:` 的首选形式是小写，但根据 BIP21 和 [RFC3986][] 的规定，它也可以大写。这也产生了一个不那么复杂的图像（尽管在这种情况下，我们的二维码编码库给了两个图像相同的尺寸）。

![bech32 全大写](/img/posts/2019-05-bip21-bech32-qr-uc.png)
{:.center}

<div markdown="1" id="bip21-complications">
不幸的是，BIP21 URI 中传递附加参数所需的 `?` 和 `&` 不属于二维码的大写字符集，因此只能为这些字符使用二进制模式。此外，BIP21 规定查询参数名称如 `amount` 和 `label` 是区分大小写的，所以它们的大写版本预计也不能正常工作。

{:#qrcode-edit}
然而，二维码可以支持混合字符集，当使用一个以全大写子字符串（包含 bech32 地址）开头或结尾的字符串时，这样做总是至少稍微更有效率。这是因为 bech32 地址的最小允许大小（14 个字符）与使用大写模式的效率增益（31.25%）相结合，超过了切换模式的最坏情况开销（20 个额外的比特）。我们知道的至少有两个二维码编码器 [libqrencode][]（C 语言）和 [node-qrcode][]（JS 语言），默认情况下会根据需要自动混合字符集，以生成最不复杂的二维码：

![BIP21/bech32 混合字符模式](/img/posts/2019-05-bip21-bech32-qr-mixed.png)
{:.center}
</div>

总之，当在二维码中使用 bech32 地址时，考虑将它们和任何其他可以大写的相邻字符大写，以生成更小且不太复杂的二维码。（然而，出于其他所有目的，bech32 地址应使用全小写字符。）

*更正：*本节的早期版本声称包含 BIP21 查询参数的二维码需要使用二进制模式。Nadav Ivgi 友好地[通知我们][ivgi tweet]，可以混合字符模式，因此我们已相应更新了本节的最后两段。

[rfc3986]: https://tools.ietf.org/html/rfc3986#section-3.1
[ivgi tweet]: https://twitter.com/shesek/status/1131733590235131905
[node-qrcode]: https://github.com/soldair/node-qrcode#mixed-modes
[libqrencode]: https://fukuchi.org/works/qrencode/

[^only-bc]:
    Bech32 地址有三个部分，可读前缀 (HRP)，例如 `bc`，分隔符（始终为 `1`）和数据部分。分隔符和数据部分保证是二维码的*大写字母和数字*字符集的一部分，但根据 BIP173 允许在 HRP 中使用的字符范围包括不属于该大写字母和数字字符集的标点符号。具体来说，以下字符在 bech32 HRP 中是允许的，但不属于二维码大写字母和数字字符集：

    ```
    !"#&'()';<=>?@[\]^_`{|}~
    ```

    我们所知比特币中使用的 bech32 HRP（bc、tb、bcrt）都不使用这些字符，其他应用程序也没有使用。然而，在代码中，你可能不想假设非比特币 bech32 地址的二维码总是可以使用大写字母生成较小的二维码。
